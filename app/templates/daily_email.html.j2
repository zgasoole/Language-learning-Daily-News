<!doctype html>
<html lang="zh">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>German Daily Learning</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        background: #f3f5f7;
        font-family: 'Trebuchet MS', 'Segoe UI', sans-serif;
        color: #1a1f24;
      }
      .wrapper {
        max-width: 820px;
        margin: 24px auto;
        background: #ffffff;
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid #dde3ea;
      }
      .hero {
        padding: 28px;
        background: linear-gradient(120deg, #fef4d7, #d7ecff);
      }
      .hero h1 {
        margin: 0 0 8px;
        font-size: 26px;
      }
      .hero p {
        margin: 0;
        color: #425466;
      }
      .section {
        padding: 24px 28px;
        border-top: 1px solid #edf2f7;
      }
      .section h2 {
        margin: 0 0 12px;
        font-size: 20px;
      }
      .news {
        line-height: 1.8;
        font-size: 16px;
      }
      .hint {
        background: #fff7e6;
        border: 1px solid #ffdf9d;
        color: #7a5900;
        padding: 10px 12px;
        border-radius: 8px;
        font-size: 13px;
      }
      .parallel-table {
        width: 100%;
        border-collapse: collapse;
        border: 1px solid #e0e8f2;
        border-radius: 10px;
        overflow: hidden;
      }
      .parallel-table th,
      .parallel-table td {
        border-bottom: 1px solid #e7edf4;
        vertical-align: top;
        padding: 10px;
        line-height: 1.75;
        font-size: 15px;
      }
      .parallel-table th {
        background: #f7fbff;
        text-align: left;
        font-size: 14px;
      }
      .word-card {
        border: 1px solid #e7ecf2;
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 12px;
        background: #fcfdff;
      }
      .word-card h3 {
        margin: 0 0 8px;
        font-size: 18px;
      }
      .meta {
        color: #637282;
        font-size: 13px;
      }
      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid #ccd7e5;
        background: #f4f8fc;
      }
      .footer {
        padding: 20px 28px;
        color: #6b7785;
        font-size: 12px;
        background: #f8fbff;
      }
      a.button {
        display: inline-block;
        padding: 9px 14px;
        border-radius: 8px;
        text-decoration: none;
        margin-right: 8px;
        margin-top: 6px;
        font-size: 13px;
        border: 1px solid #c9d8eb;
        color: #17324d;
        background: #eef6ff;
      }
      .source a {
        color: #185ba5;
      }
      .feedback-form {
        border: 1px solid #e5ebf3;
        border-radius: 10px;
        padding: 12px;
        background: #f9fcff;
      }
      .feedback-form .row {
        margin: 8px 0;
      }
      .feedback-form label {
        margin-right: 12px;
        font-size: 14px;
      }
      .submit-btn {
        margin-top: 10px;
        display: inline-block;
        padding: 10px 14px;
        border: 1px solid #a4c4e8;
        border-radius: 8px;
        background: #dff0ff;
        color: #16395f;
        font-weight: 600;
      }
      .detail-box {
        background: #fafcff;
        border: 1px solid #e6eef8;
        border-radius: 10px;
        padding: 12px;
        white-space: pre-line;
        line-height: 1.75;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <div class="hero">
        <h1>Deutsch Daily News</h1>
        <p>{{ today }} · Niveau {{ lesson.cefr_level }} · 1 News + 5 Worter + 1 Grammatik</p>
      </div>

      <div class="section">
        <h2>{{ lesson.title }}</h2>
        <div class="news">{{ lesson.news_text }}</div>
      </div>

      <div class="section">
        <h2>德语原文与中文对照（按句对齐）</h2>
        <table class="parallel-table">
          <thead>
            <tr>
              <th style="width:50%;">Deutsch</th>
              <th style="width:50%;">中文</th>
            </tr>
          </thead>
          <tbody>
            {% for pair in sentence_pairs %}
            <tr>
              <td>{{ pair.de_sentence }}</td>
              <td>{{ pair.zh_sentence }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <div style="margin-top: 14px;">
          <h3 style="margin: 0 0 8px; font-size: 16px;">音频</h3>
          {% if audio_url %}
          <p><a class="button" href="{{ audio_url }}">播放/下载 MP3</a></p>
          {% elif has_audio_attachment %}
          <p>本次音频已作为邮件附件发送，请在附件区域播放。</p>
          {% else %}
          <p>本次音频暂时生成失败，今天先阅读文本；系统会继续自动重试。</p>
          {% endif %}
        </div>
      </div>

      <div class="section">
        <h2>重点词汇 (5)</h2>
        {% for card in word_cards %}
        <div class="word-card">
          <h3>{{ card.word.word }} <span class="badge">{{ card.word.part_of_speech }}</span></h3>
          <p><strong>释义(德):</strong> {{ card.word.explanation }}</p>
          <p><strong>词源:</strong> {{ card.word.etymology }}</p>
          <p><strong>构词(中文拆解):</strong> {{ card.word.morphology }}</p>
          <p><strong>时态/变位:</strong> {{ card.word.tense_or_inflection }}</p>
          <p><strong>英/中:</strong> {{ card.word.translation_en }} / {{ card.word.translation_zh }}</p>
          <p><strong>例句:</strong> {{ card.word.example_sentence_de }}</p>
          <p class="meta">当前掌握度: {{ card.status_label }}</p>
        </div>
        {% endfor %}
      </div>

      <div class="section">
        <h2>今日语法（讲透版）</h2>
        <p><strong>主题:</strong> {{ lesson.grammar_point.topic }}</p>
        <p><strong>原句:</strong> {{ lesson.grammar_point.source_sentence }}</p>
        <p><strong>核心解释:</strong> {{ lesson.grammar_point.explanation_zh }}</p>
        <div class="detail-box"><strong>详细讲解:</strong>
{{ lesson.grammar_point.explanation_zh_detailed }}</div>
        <p><strong>补充例句:</strong> {{ lesson.grammar_point.example_de }}</p>
        <p><strong>学习建议:</strong> {{ lesson.grammar_point.study_tips_zh }}</p>
        <p><strong>当前语法状态:</strong> {{ grammar_status_label }}</p>
        <p><a class="button" href="{{ lesson.grammar_point.reference_url }}">我要上网看更多解释</a></p>
      </div>

      <div class="section">
        <h2>一次提交本次学习反馈</h2>
        <p class="hint">建议在 Apple Mail（iPhone/Mac）中使用。勾选后点击一次提交，会生成一封反馈邮件；发送后即可同步到词库和语法库。</p>

        <form class="feedback-form" action="{{ feedback_form_action }}" method="post" enctype="text/plain">
          <input type="hidden" name="lln_feedback" value="1" />
          <input type="hidden" name="token" value="{{ feedback_token if feedback_token is defined else '' }}" />
          <input type="hidden" name="lesson_id" value="{{ lesson.lesson_id }}" />
          <input type="hidden" name="language" value="{{ lesson.language }}" />

          {% for card in word_cards %}
          <div class="row">
            <input type="hidden" name="word_{{ card.idx }}_text" value="{{ card.word.word }}" />
            <strong>{{ card.word.word }}</strong>：
            <label><input type="radio" name="word_{{ card.idx }}_status" value="unknown" {% if card.status == 'unknown' %}checked{% endif %}/> 完全不懂</label>
            <label><input type="radio" name="word_{{ card.idx }}_status" value="fuzzy" {% if card.status == 'fuzzy' %}checked{% endif %}/> 隐约懂点</label>
            <label><input type="radio" name="word_{{ card.idx }}_status" value="known" {% if card.status == 'known' %}checked{% endif %}/> 熟悉</label>
          </div>
          {% endfor %}

          <div class="row">
            <input type="hidden" name="grammar_topic" value="{{ lesson.grammar_point.topic }}" />
            <strong>语法 {{ lesson.grammar_point.topic }}</strong>：
            <label><input type="radio" name="grammar_status" value="mastered" {% if grammar_status == 'mastered' %}checked{% endif %}/> 我已掌握</label>
            <label><input type="radio" name="grammar_status" value="review" {% if grammar_status != 'mastered' %}checked{% endif %}/> 我需要再学习</label>
          </div>

          <div class="row">
            <input class="submit-btn" type="submit" value="提交本次反馈（一次发送）" />
          </div>
        </form>

        <p style="margin-top:12px;" class="meta">如果当前邮箱客户端不支持表单，请使用备用入口：</p>
        <p><a class="button" href="{{ feedback_fallback_link }}">打开反馈草稿（一次发送）</a></p>
      </div>

      <div class="section source">
        <h2>新闻来源</h2>
        {% for url in lesson.source_urls %}
        <p><a href="{{ url }}">{{ url }}</a></p>
        {% endfor %}
      </div>

      <div class="footer">
        Daily learning pipeline generated by GitHub Actions.
      </div>
    </div>
  </body>
</html>
